name: Deploy and Security Scan (OWASP ZAP)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”¹ Checkout del repositorio
        uses: actions/checkout@v4

      - name: ðŸ”¹ Login en Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ”¹ Crear grupo de recursos
        run: |
          az group create -n rg-devsecopsuc -l eastus || true

      - name: ðŸ”¹ Desplegar infraestructura con Bicep
        run: |
          az deployment group create \
            -g rg-devsecopsuc \
            --template-file ./Unidad2_DespliegueYOperacionesSeguras/bicep/main.bicep \
            --parameters webAppName=devsecopsuc-webapp appServicePlanName=asp-devsecopsuc

      - name: ðŸ”¹ Login al Azure Container Registry
        run: az acr login --name devsecopsucacr

      - name: ðŸ”¹ Construir y subir imÃ¡genes Docker
        run: |
          docker build -t devsecopsucacr.azurecr.io/auth-service:latest -f ./Unidad2_DespliegueYOperacionesSeguras/docker/Dockerfile.auth .
          docker push devsecopsucacr.azurecr.io/auth-service:latest

          docker build -t devsecopsucacr.azurecr.io/rooms-service:latest -f ./Unidad2_DespliegueYOperacionesSeguras/docker/Dockerfile.rooms .
          docker push devsecopsucacr.azurecr.io/rooms-service:latest

          docker build -t devsecopsucacr.azurecr.io/frontend:latest -f ./Unidad2_DespliegueYOperacionesSeguras/docker/Dockerfile.frontend .
          docker push devsecopsucacr.azurecr.io/frontend:latest

      - name: ðŸ”¹ Configurar contenedores en Azure Web App
        run: |
          az webapp config container set \
            --name devsecopsuc-webapp \
            --resource-group rg-devsecopsuc \
            --multicontainer-config-type compose \
            --multicontainer-config-file ./Unidad2_DespliegueYOperacionesSeguras/docker/docker-compose.yml

      - name: ðŸ•“ Esperar despliegue antes de anÃ¡lisis
        run: sleep 40

      - name: ðŸ”¹ Instalar OWASP ZAP CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          docker pull owasp/zap2docker-stable

      - name: ðŸ§ª Ejecutar anÃ¡lisis OWASP ZAP
        run: |
          docker run --rm -v $(pwd):/zap/wrk:rw \
            owasp/zap2docker-stable zap-baseline.py \
            -t https://devsecopsuc-webapp.azurewebsites.net \
            -r zap_report.html || true

      - name: ðŸ§¾ Ajustar permisos del reporte
        run: |
          sudo chmod 777 zap_report.html || true
          ls -l zap_report.html

      - name: ðŸ“¤ Subir reporte como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-Security-Report
          path: zap_report.html

      - name: âœ… Finalizar
        run: echo "Despliegue y anÃ¡lisis OWASP ZAP completados correctamente."
